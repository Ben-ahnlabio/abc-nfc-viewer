<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFT</title>
    <link href="style.css" rel="stylesheet" />
    <style></style>
  </head>
  <body>
    <h1>NFT</h1>
    <div>
      <div>
        <select id="baseUrl">
          <option>https://abc-nft-368700.de.r.appspot.com</option>
          <option>http://localhost:8000</option>
        </select>
      </div>
      <h2>address</h2>
      <form>
        EOA :
        <input id="inputAddress" type="text" placeholder="EOA Address" />
        <select id="selectChain">
          <option>ethereum</option>
          <option>polygon</option>
          <option>klaytn</option>
          <option>binance</option>
        </select>
        <label for="chkResync">resync</label>
        <input id="chkResync" type="checkbox" />
        <input id="btnSubmit" type="submit" value="show NFT" />
      </form>
      <h2>ethereum</h2>
      <ul class="address-list address-list-ethereum">
        <li><span>0x2488f090656BddB63fe3Bdb506D0D109AaaD93Bb</span></li>
        <li><span>0x5B5bc2767919f02dE66E31d4cf90aD7A68e9C797</span></li>
        <li><span>0x0232d1083E970F0c78f56202b9A666B526FA379F</span></li>
        <li><span>0xB9c7eCd75DD5f4e57C236658E5b5Ab0a04D3bFC7</span></li>
        <li><span>0xC6F6c64B87A7Aba3f46D6c717FEe13314da4Ae27</span>(Sean)</li>
        <li><span>0x90ef80035dF87DE9d211de8E8EE7D3cEE9488619</span>(Daisy)</li>
        <li><span>0x31bf89ac0576BB926Aa960008bCC6b59fb828004</span>(Ikko)</li>
      </ul>

      <h2>klaytn</h2>
      <ul class="address-list address-list-klaytn">
        <li><span>0x03E5ecA4B61412A5ece56928318d00c3b5567ef8</span></li>
        <li><span>0x9B0582d70744464D7c3Ca4452490Ea2F0a0db6a4</span></li>
        <li><span>0x745C09006E76f9c357E9de6DF0f28a336fc7CB3C</span></li>
        <li><span>0xf901be601848b31Bc4455d5C405B0FbC2401c9b4</span>(Ethan)</li>
        <li><span>0x31bf89ac0576BB926Aa960008bCC6b59fb828004</span>(Ikko)</li>
      </ul>

      <h2>polygon</h2>
      <ul class="address-list address-list-polygon">
        <li><span>0xE36223C79EAA9d1e436ab4348721a1c55B46B7c4</span></li>
        <li><span>0xB9c7eCd75DD5f4e57C236658E5b5Ab0a04D3bFC7</span></li>
        <li><span>0xC6F6c64B87A7Aba3f46D6c717FEe13314da4Ae27</span>(Sean)</li>
      </ul>

      <h2>binance</h2>
      <ul class="address-list address-list-binance">
        <li><span>0x609306d8890904a0019997585018b70c8c4e1fea</span></li>
        <li><span>0x308318B98B48C1fdfa72efd0BD3F5233c4b45AA9</span></li>
        <li><span>0xBAE94f68292E0d08297EF69382D54D292E6aeF17</span></li>
        <li><span>0x6cAF4Ac5B3ADDdAb07d3eFf7F17dB8245f481909</span></li>
        <li>
          <span>0xe0a9e5b59701a776575fdd6257c3f89ae362629a</span> (binance NFT
          contract)
        </li>
      </ul>

      <ul id="nftList"></ul>
    </div>
    <script>
      function init() {
        const btnSubmit = document.getElementById("btnSubmit");
        btnSubmit.addEventListener("click", (e) => {
          e.preventDefault();
          const inputAddress = document.getElementById("inputAddress");
          const chainSelect = document.getElementById("selectChain");
          const nftList = document.getElementById("nftList");
          const baseUrl = document.getElementById("baseUrl");
          const inputCursor = document.getElementById("inputCursor");
          const chkResync = document.getElementById("chkResync");
          nftList.innerHTML = "";
          getNfts(
            baseUrl.value,
            inputAddress.value.trim(),
            chainSelect.value,
            chkResync.checked ? "true" : "false"
          );
          nftList.innerHTML = "<li><h3>Loading...</h3></li>";
        });

        addAddressClickEvent("ethereum");
        addAddressClickEvent("polygon");
        addAddressClickEvent("klaytn");
        addAddressClickEvent("binance");
      }

      async function getNfts(baseUrl, owner, chain, resync) {
        //const url = `https://abc-nft-368700.de.r.appspot.com/v1/nfts/${chain}?owner=${owner}&resync=false`;
        // const url = `http://localhost:8000/v1/nfts/${chain}?owner=${owner}&resync=false`;
        const url = `${baseUrl}/v1/nfts/${chain}?owner=${owner}&resync=${resync}`;
        const response = await fetch(url);
        const data = await response.json();
        render(data);
      }

      function render(data) {
        const nftList = document.getElementById("nftList");
        nftList.innerHTML = "";
        data.items.map((item) => {
          const li = document.createElement("li");
          li.setAttribute("class", "nft-item");
          nftList.append(li);
          li.innerHTML = `
          <div class="nft-source">
            ${getNftElement(item)}
          </div>
          <div>
            <p class="nft-contract-name">${item.contract_name} </p>
            <p class="nft-name">${item.name} </p>
            <p class="nft-type">${item.token_type} </p>
            <p class="nft-contract-addr">${item.contract_address}</p>
            <p class="nft-contract-token-id">${item.token_id}</p>
            ${
              item.external_url !== null
                ? `<p class="nft-link"><a target="_blank" href="${item.external_url}">${item.external_url}`
                : ``
            }
          </a></p>
          ${
            item.description !== null
              ? `<p class="nft-desc">${item.description} </p>`
              : ""
          }
          ${renderAttributes(item)}
          </div>
          `;
        });
      }

      function getNftElement(nftMetadata) {
        if (
          nftMetadata.content_type === "video/mp4" ||
          nftMetadata.content_type === "audio/mp4" ||
          nftMetadata.content_type === "video/x-m4v"
        ) {
          return `<video controls style='height:250px;' src="${nftMetadata.source_url.original}" >`;
        }

        if (nftMetadata.content_type === "image/svg+xml") {
          return `<img style='height:250px;' alt="${nftMetadata.source_url?.original}" src="${nftMetadata.source_url?.original}" >`;
        }

        if (nftMetadata.source_url !== null && nftMetadata.source_url.h250) {
          return `<a target="_blank" href="${nftMetadata.source_url.original}"><img style='height:250px;' alt="${nftMetadata.source_url?.h250}" src="${nftMetadata.source_url?.h250}" ></a>`;
        } else {
          return `<a target="_blank" href="${nftMetadata.image}"><img style='height:250px;' alt="${nftMetadata.image}" src="${nftMetadata.image}" ></a>`;
        }

        if (nftMetadata.image === null) {
          return "";
        }
      }

      function renderAttributes(item) {
        if (item.attributes.length > 0) {
          return `<ul class="attributes-list">
              ${item.attributes
                .map(
                  (attr) =>
                    `<li class="attributes-item">${attr.trait_type} : ${attr.value}</li>`
                )
                .join("")}
            </ul>`;
        } else {
          return "";
        }
      }

      function addAddressClickEvent(chain) {
        const addressItem = document.querySelectorAll(
          `ul.address-list-${chain} li span`
        );
        Array.from(addressItem).forEach((element) =>
          element.addEventListener("click", (e) => {
            const textSpan = element.querySelector("span");
            const inputAddress = document.getElementById("inputAddress");
            const selectChain = document.getElementById("selectChain");
            inputAddress.value = element.innerHTML;
            selectChain.value = chain;
          })
        );
      }

      init();
    </script>
  </body>
</html>
